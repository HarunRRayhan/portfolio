# Harun's Portfolio Deployment

This directory contains scripts and configuration for fully automated infrastructure provisioning and deployment of the Laravel portfolio application on AWS Lightsail, with Dockerized services and persistent PostgreSQL storage.

## Directory Structure

- `infra-create.sh` — Provisions infrastructure using Terraform, updates secrets, waits for SSH
- `infra-destroy.sh` — Destroys all provisioned infrastructure
- `deploy.sh` — Deploys the application, builds frontend, uploads assets, sets up Docker, runs migrations, and more
- `docker/` — Contains `docker-compose.yml`, `Dockerfile`, and related files (now inside `docker/`)
- `.env.deploy` — Deployment environment variables (merged into `.env` for deployment)
- `portfolio-key.pem` — SSH private key (auto-generated by infra-create.sh)

## Prerequisites

- AWS CLI and credentials configured
- Terraform installed
- Node.js >= 18 and npm
- jq, zip, unzip, curl, and other common CLI tools

## Usage

### 1. Provision Infrastructure

```
cd deploy
./infra-create.sh
```
- This will run `terraform apply -auto-approve`, update `.env.deploy` with the new public IP, and write the SSH key to `portfolio-key.pem`.
- Wait for the script to finish and for SSH to become available (the script waits automatically).

### 2. Deploy the Application

```
./deploy.sh
```
- Builds frontend assets locally
- Uploads assets and code to the server
- Sets up Docker containers (app, db, nginx)
- Ensures PostgreSQL data is persisted via a Docker volume
- Waits for the database to be healthy before starting the app
- Runs Laravel migrations and caches
- Verifies DB connection from inside the app container
- Optionally purges Cloudflare CDN cache if configured

### 3. Destroy Infrastructure

```
./infra-destroy.sh
```
- Runs `terraform destroy -auto-approve` to tear down all resources

## Dockerized Database & Persistence
- The PostgreSQL database runs in a Docker container with a named volume (`postgres_data`) for persistent storage.
- Data is not lost when containers are recreated or the app is redeployed.

## Environment Variables
- `.env.deploy` is merged with `.env.example` and `.env.appprod` to generate the final `.env` used for deployment.
- Database credentials and other secrets are managed here.

## Troubleshooting
- If you see SSH or connection errors, ensure the Lightsail instance is up and the IP is correct in `.env.deploy`.
- If Docker Compose fails, check that the `docker/` directory is present inside `deploy/` and all paths are correct.
- For frontend build issues, ensure Node.js >= 18 is installed and available.
- For Cloudflare cache purge issues, ensure your API token and zone ID are correct in `.env.deploy`.

## Notes
- All scripts are idempotent and safe to re-run.
- The deployment script (`deploy.sh`) will fail and exit on any error.
- The app container will only start after the database is healthy.
- All logs are saved in `deploy/log/deploy.log`.

All scripts and deployments now use `docker/docker-compose.yml` as the canonical Compose file.

---

**Automate, deploy, and enjoy!**

# Blue-Green Zero-Downtime Deployment (Traefik + Nginx + PHP-FPM)

## Overview
This deployment uses Traefik as a TLS-terminating reverse proxy, with blue/green Nginx+PHP-FPM stacks for zero-downtime Laravel deployments. Traffic is switched instantly by updating weights in a dynamic Traefik config.

## Requirements
- Docker & Docker Compose installed on the server
- Ports 80/443 open
- Cloudflare set to DNS-only (grey cloud) for your domain
- Laravel app code mounted in `../` relative to `docker/`

## How it works
- `traefik` container terminates TLS and routes to either `nginx_blue` or `nginx_green` based on weights in `docker/traefik-dynamic.yml`.
- Each Nginx proxies `.php` to its paired PHP-FPM container.
- Blue is live, green is standby for new release.
- Deploy script brings up green, runs migrations, flips weights, and (optionally) removes blue.

## Usage

1. **Deploy new version (zero-downtime):**

```sh
cd deploy
./bluegreen-deploy.sh
```

- This brings up green, runs migrations, flips traffic to green, and keeps blue for quick rollback.

2. **Remove blue after verification:**

```sh
./bluegreen-deploy.sh --remove-blue
```

3. **Rollback:**
- Edit `docker/traefik-dynamic.yml` to set `web-blue` weight to 100 and `web-green` to 0.
- Restart Traefik:

```sh
docker compose -f ../docker/docker-compose.yml restart traefik
```
- (Optional) Remove green:

```sh
docker compose -f ../docker/docker-compose.yml stop nginx_green php_green
```

## Notes
- Traefik auto-reloads the dynamic config file.
- You can automate this script in CI/CD for seamless deployments.
- For more on CI/CD best practices, see [Zeet CI/CD Strategy](https://zeet.co/blog/ci-cd-strategy).

---

**Security:** All traffic is TLS-terminated at Traefik. You can add monitoring, RBAC, and further automation as needed. 